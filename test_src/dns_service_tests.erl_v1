%%% -------------------------------------------------------------------
%%% Author  : uabjle
%%% Description : 
%%% 
%%% Created : 10 dec 2012
%%% -------------------------------------------------------------------
-module(dns_service_tests). 
   
%% --------------------------------------------------------------------
%% Include files
%% --------------------------------------------------------------------
-include_lib("eunit/include/eunit.hrl").
-include("common_macros.hrl").
%% --------------------------------------------------------------------

-define(TEST_VECTOR,[{"s1","ip1",1},{"s11","ip1",2},
		     {"s2","ip2",1},{"s21","ip1",1},
		     {"s3","ip1",2},{"s21","ip1",1},
		     {"s1","ip2",1},{"s21","ip2",1}]).

%% External exports
%-export([start/0]).
-compile(export_all).


%% ====================================================================
%% External functions
%% ====================================================================

%% --------------------------------------------------------------------
%% Function:tes cases
%% Description: List of test cases 
%% Returns: non
%% --------------------------------------------------------------------
cases_test()->
    start_server_test(),
    add_services(),
    get_services_1(),
    delete_services(),
    get_services_2(),
    clean_stop().


%% --------------------------------------------------------------------
%% Function:start/0 
%% Description: Initiate the eunit tests, set upp needed processes etc
%% Returns: non
%% --------------------------------------------------------------------
start_server_test()->
    {spawn,
     {setup,
      fun()->
	      ?assertEqual(ok,application:start(dns_service)),
	      Node=node(),
	      ?assertEqual({pong,Node,dns_service},dns_service:ping())
      end,
      fun(_)->
	      ok 
      end
     }
     }.


%% --------------------------------------------------------------------
%% Function:start/0 
%% Description: Initiate the eunit tests, set upp needed processes etc
%% Returns: non
%% --------------------------------------------------------------------
start()->
    spawn(fun()->eunit:test({timeout,1*60,dns_service_tests}) end).

clean_start()->
    ?assertEqual(ok,application:start(dns_service)),
    Node=node(),
    ?assertEqual({pong,Node,dns_service},dns_service:ping()),
    ok.

clean_stop()->
    ?assertEqual(ok,application:stop(dns_service)),
    timer:sleep(1000),
    init:stop(),
    ok.



%% --------------------------------------------------------------------
%% Function:support functions
%% Description: Stop eunit tests, set upp needed processes etc
%% Returns: non
%% --------------------------------------------------------------------
ping_test()->
    Node=node(),
    ?assertEqual({pong,Node,dns_service},dns_service:ping()).
    

%% --------------------------------------------------------------------
%% Function:support functions
%% Description: Stop eunit tests, set upp needed processes etc
%% Returns: non
%% --------------------------------------------------------------------
delete_services()->
    dns_service:delete("s21","ip2",1),
    dns_service:delete("s3","ip1",2),
    dns_service:delete("s1","glurk",1),    
    ok.


add_services()->
    [dns_service:add(S,I,P)||{S,I,P}<-?TEST_VECTOR],
    [dns_service:add(S,I,P)||{S,I,P}<-?TEST_VECTOR],
    ok.

get_services_2()->
    ?assertEqual([{"s1","ip2",1},
                      {"s21","ip1",1},
                      {"s2","ip2",1},
                      {"s11","ip1",2},
                      {"s1","ip1",1}]  ,dns_service:all()),
   ?assertEqual([{"ip1",1}],dns_service:get("s21")),
		
   ?assertEqual([],dns_service:get("s3")),
   ?assertEqual([],dns_service:get("glurk")),
   ?assertEqual([{"ip2",1},
		 {"ip1",1}],dns_service:get("s1")), 
    ok.

get_services_1()->
    ?assertEqual([{"s21","ip2",1},
		  {"s1","ip2",1},
		  {"s21","ip1",1},
		  {"s3","ip1",2},
		  {"s2","ip2",1},
		  {"s11","ip1",2},
		  {"s1","ip1",1}],dns_service:all()),
   ?assertEqual([{"ip2",1},
		 {"ip1",1}],dns_service:get("s21")),
		
   ?assertEqual([{"ip1",2}],dns_service:get("s3")),
   ?assertEqual([],dns_service:get("glurk")),    
    ok.
    
